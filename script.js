const yoKaiList = [
    { name: "Pandle", img: "alcaldero.png" },
    { name: "Undy", img: "sinna.png" },
    { name: "Tanbo", img: "sinnareno.png" },
    { name: "Cutta-nah", img: "katano.png" },
    { name: "Cutta-nah-nah", img: "katananai.png" },
    { name: "Slacka-slash", img: "katakroken.png" },
    { name: "Mochismo", img: "mochimacho.png" },
    { name: "Minochi", img: "machimio.png" },
    { name: "Helmsman", img: "yelmandante.png" },
    { name: "Reukight", img: "juntollero.png" },
    { name: "Corptain", img: "genedaver.png" },
    { name: "Blazion", img: "flamileon.png" },
    { name: "Quaken", img: "tembloleon.png" },
    { name: "Siro", img: "sirleon.png" },
    { name: "Chansin", img: "ludorai.png" },
    { name: "Sheen", img: "lustre.png" },
    { name: "Snee", img: "Furtre.png" },
    { name: "Gleam", img: "dortre.png" },
    { name: "Benkei", img: "benkei.png" },
    { name: "B3-NK1", img: "b3-nk1.png" },
    { name: "Sushiyama", img: "sushiyama.png" },
    { name: "Kapunki", img: "kapunki.png" },
    { name: "Beetler", img: "lucharabajo.png" },
    { name: "Betall", img: "camperabajo.png" },
    { name: "Cruncha", img: "chafarabajo.png" },
    { name: "Zerberker", img: "osfurio.png" },
    { name: "Snartle", img: "sacoco.png" },
    { name: "Shogunyan", img: "shogunyan.png" },
    { name: "Brushido", img: "Milimpiano.png" },
    { name: "Washogun", img: "Samulimpio.png" },
    { name: "Lie-in", img: "Dormileon.png" },
    { name: "Lie-in Heart", img: "Leon_Alfa.png" },
    { name: "Hissfit", img: "Pataleto.png" },
    { name: "Tublappa", img: "Chupatinas.png" },
    { name: "Slicenrice", img: "Cortarroz.png" },
    { name: "Flamurice", img: "Socarrat.png" },
    { name: "Mudmunch", img: "Atierrador.png" },
    { name: "Sgt. Burly", aliases: ["Sgt. Burly", "Sgt Burly", "Sargeant Burly"], img: "Capi-Cachas.png" },
    { name: "Demuncher", img: "Devoramonios.png" },
    { name: "Devourer", img: "Devoralmas.png" },
    { name: "Machonyan", img: "Tigrenyan.png" },
    { name: "Hovernyan", img: "Hovernyan.png" },
    { name: "Slumberhog", img: "Puergazan.png" },
    { name: "Snortlehog", img: "Torreznio.png" },
    { name: "Samureel", img: "Samuranguila.png" },
    { name: "Time Keeler", img: "Anguilocio.png" },
    { name: "Moximous N", img: "Ultra_N.png" },
    { name: "Moximous K", img: "Ultra_K.png" },
    { name: "Illuminoct", img: "Iluminocto.png" },
  { "name": "Sir Nyansalot", "img": "Sir_Nyancelot.png" },
  { "name": "Momonyan", "img": "Momonyan.png" },
  { "name": "Bison Burly", "img": "Coman-cachas.png" },
  { "name": "Arachnevil", "img": "Aracnefico.png" },
  { "name": "Sigh-Durr", "img": "Robin_Ful.png" },
  { "name": "Flippit", "img": "Tornalmohado.png" },
  { "name": "Brutle", "img": "Gran_Coco.png" },
  { "name": "Minimoto", "img": "Minimoto.png" },
  { "name": "Goofball", "img": "Bola_Blanda.png" },
  { "name": "Slugger", "img": "Bateados.png" },
  { "name": "Lappinitup", "img": "Chupapremios.png" },
  { "name": "El Gutso", "img": "Guerrero_Guey.png" },
  { "name": "El Gutso Grande", "img": "Huracan_Guey.png" },
  { "name": "BBQvil", "img": "Barbacoo.png" },
  { "name": "Liarbird", "img": "Piopio_Yonohesido.png" },
  { "name": "Hot Air Buffoon", "img": "Globonauta.png" },
  { "name": "Shurikenny", "img": "Shurikenny.png" },
  { "name": "Nunchucky", "img": "Nunchucky.png" },
  { "name": "Camellia", "img": "Camelia.png" },
  { "name": "Originyan", "img": "Originyan.png" },
  { "name": "Acenyan", "img": "Asnyan.png" },
  { "name": "Bishamonten", "img": "Bishamonten.png" },
  { "name": "Columbakat", "img": "Gatobal_Colon.png" },
  { "name": "The Last Nyanmurai", "img": "Ultimo_Nyanmurai.png" },
  { "name": "Asura", "img": "Todobelicoso.png" },
  { "name": "Supernyan", "img": "Supernyan.png" },
  { "name": "Hovernyan S", "img": "Hovernyan_S.png" },
  { "name": "Hovernyan Cao Cao", "img": "Hovernyan_Cao_Cao.png" },
  { "name": "Righteous Zazel", aliases: ["Righteous Zazel", "Rgt. Zazel", "Rgt Zazel"], "img": "Zazel_Justiciero.png" },
  { "name": "Rampajah", "img": "Maharazas.png" },
  { "name": "Moolinda", "img": "Bovida.png" },
  { "name": "Neighthan", "img": "Equinio.png" },
  { "name": "El Dorago", "img": "Dradorado.png" },
  { "name": "The Hinix", "img": "Fenixtelecto.png" },
  { "name": "Shourinji", img: "Shourinji.png" },
  { "name": "AkiraMEN", img: "AkiraMEN.png" },
  { "name": "Crystal Shogunyan", aliases: ["Shogunyan C", "Crystal Shogunyan"], img: "Shogunyan_Cristal.png" },
  { "name": "Wobblehover", aliases: ["Wobblehover", "Wibblehover", "Punifuyu"], img: "Wobblehover.png" },
  { "name": "Dandory", img: "Dandory.png" },
];

let score = 0; 
let gameEnded = false; // Evita cambios una vez terminado el juego
const unlockedYoKai = new Set(); // Registro de Yo-kai desbloqueados por índice

// Normalizar la entrada del usuario (sin tildes y en minúsculas)
function normalizeString(str) {
    return str.normalize("NFD").replace(/[̀-\u036f]/g, "").toLowerCase();
}

// Crear el objeto de audio una sola vez
let getSound = new Audio("get.mp3");

// Reproducir sonido cuando se desbloquea un Yo-kai (sin solapamiento)
function playGetSound() {
    if (!getSound.paused) {
        getSound.pause(); // Detener el sonido actual si ya está reproduciéndose
        getSound.currentTime = 0; // Reiniciar el sonido al principio
    }
    getSound.play(); // Reproducir el sonido
}

// Actualizar la puntuación en formato (adivinados / totales)
function updateScoreDisplay() {
    const scoreDisplay = document.getElementById("score");
    scoreDisplay.textContent = `${score}/${yoKaiList.length}`;
}

// Verificar la respuesta del usuario
function checkAnswer() {
    if (gameEnded) return; // Si el juego ha terminado, no hacer nada

    const userAnswer = normalizeString(document.getElementById("answer-input").value.trim());

    let correctGuess = false; // Bandera para reproducir el sonido solo si hay aciertos

    yoKaiList.forEach((yoKai, index) => {
        // Normaliza todos los nombres asociados al Yo-kai
        const normalizedNames = [yoKai.name, ...(yoKai.aliases || [])].map(name => normalizeString(name));

        // Si la respuesta coincide con alguno de los nombres y no ha sido desbloqueado
        if (normalizedNames.includes(userAnswer) && !unlockedYoKai.has(index)) {
            const yoKaiImg = document.getElementById(`yo-kai${index + 1}`);
            if (yoKaiImg && yoKaiImg.src.includes("no-kai.png")) {
                yoKaiImg.src = yoKai.img; // Actualiza la imagen

                // Añadir clase para animación
                yoKaiImg.classList.add("yokai-unlocked");
                yoKaiImg.addEventListener("animationend", () => {
                    yoKaiImg.classList.remove("yokai-unlocked"); // Quitar clase tras animación
                });

                unlockedYoKai.add(index); // Marcar el Yo-kai como desbloqueado
                score++;
                correctGuess = true; // Se encontró un acierto
            }
        }
    });

    if (correctGuess) {
        playGetSound(); // Reproducir sonido solo si hubo un acierto
        updateScoreDisplay(); // Actualizar puntuación
        document.getElementById("answer-input").value = ""; // Borra la respuesta después de un acierto
    }

    checkGameEnd(); // Verifica si el juego ha terminado
}

// Verificar si el juego ha terminado (cuando se han adivinado todos los Yo-kai)
function checkGameEnd() {
    if (score === yoKaiList.length) {
        gameEnded = true;
        stopTimer(); // Detener el temporizador
        showCongratsImage(); // Mostrar imagen de "¡Felicidades!"
    }
}

function showCongratsImage() {

    // Detener temporizador
    stopTimer();

    // Obtener tiempo final mostrado
    const tiempoTotal = document.getElementById("time").textContent;

    // Sonido de victoria
    const victorySound = new Audio("congrats.mp3");
    victorySound.volume = 0.8;
    victorySound.play().catch(() => {});

    // Panel lateral
    const finalPanel = document.createElement("div");
    finalPanel.style.position = "fixed";
    finalPanel.style.top = "0";
    finalPanel.style.right = "-350px";
    finalPanel.style.width = "320px";
    finalPanel.style.height = "100%";
    finalPanel.style.backgroundColor = "#8b0000";
    finalPanel.style.color = "white";
    finalPanel.style.padding = "20px";
    finalPanel.style.boxSizing = "border-box";
    finalPanel.style.zIndex = "1000";
    finalPanel.style.fontFamily = "Arial, sans-serif";
    finalPanel.style.display = "flex";
    finalPanel.style.flexDirection = "column";
    finalPanel.style.transition = "right 0.6s ease";

    // Botón cerrar
    const closeBtn = document.createElement("div");
    closeBtn.textContent = "✖";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "15px";
    closeBtn.style.right = "15px";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.fontSize = "18px";

    closeBtn.addEventListener("click", () => {
        finalPanel.style.right = "-350px";
        setTimeout(() => finalPanel.remove(), 600);
    });

    // Título
    const title = document.createElement("h2");
    title.textContent = `Congrats! You've guessed all the Yo-kai in ${tiempoTotal}`;
    title.style.marginTop = "40px";
    title.style.marginBottom = "30px";
    title.style.fontSize = "22px";

    // Texto Twitter
    const followText = document.createElement("p");
    followText.innerHTML = `
        If you liked it, why not follow me on twitter?: 
        <a href="https://x.com/salty_baconV2" target="_blank" style="color:#4fc3ff; text-decoration:none;">
        @Salty_BaconV2
        </a>
    `;
    followText.style.fontSize = "16px";
    followText.style.marginTop = "auto";

    // Montaje
    finalPanel.appendChild(closeBtn);
    finalPanel.appendChild(title);
    finalPanel.appendChild(followText);
    document.body.appendChild(finalPanel);

    // Animación de entrada
    setTimeout(() => {
        finalPanel.style.right = "0";
    }, 50);
}

// Temporizador
let startTime;
let timerInterval;

function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    const currentTime = Date.now();
    const elapsedTime = currentTime - startTime;

    const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
    const minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

    const formattedTime = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    document.getElementById("time").textContent = formattedTime;
}

function stopTimer() {
    clearInterval(timerInterval);
}

// Manejador de evento: validación automática con "input"
document.getElementById("answer-input").addEventListener("input", checkAnswer);

// Inicializar el marcador y temporizador al cargar la página
updateScoreDisplay(); // Inicializa la puntuación en 0/total
startTimer();

window.addEventListener("beforeunload", (event) => {
    if (score > 0) { // Mostrar advertencia solo si hay progreso
        event.preventDefault();
        event.returnValue = "¿Estás seguro de que quieres salir? Se perderá todo el progreso.";
    }
});
